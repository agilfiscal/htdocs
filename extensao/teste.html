<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste da Extens√£o √Ågil Fiscal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            background: #2c3e50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #34495e;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="radio"] {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste da Extens√£o √Ågil Fiscal</h1>
        
        <div class="status info">
            <strong>Instru√ß√µes:</strong> Esta p√°gina simula a interface de auditoria para testar a extens√£o.
        </div>

        <div class="test-section">
            <h3>üìã Tabela de Notas Fiscais (Simulada)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Sele√ß√£o</th>
                        <th>N¬∞ NFe</th>
                        <th>CNPJ</th>
                        <th>Raz√£o Social</th>
                        <th>Valor</th>
                        <th>Chave</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-nota='{"id": 1, "numero": "123456", "cnpj": "12.345.678/0001-90", "razao_social": "Empresa Teste Ltda", "valor": "1.000,00", "chave": "12345678901234567890123456789012345678901234"}'>
                        <td><input type="radio" name="nota_selecionada" value="1"></td>
                        <td>123456</td>
                        <td>12.345.678/0001-90</td>
                        <td>Empresa Teste Ltda</td>
                        <td>R$ 1.000,00</td>
                        <td>12345678901234567890123456789012345678901234</td>
                    </tr>
                    <tr data-nota='{"id": 2, "numero": "789012", "cnpj": "98.765.432/0001-10", "razao_social": "Outra Empresa S.A.", "valor": "2.500,00", "chave": "98765432109876543210987654321098765432109876"}'>
                        <td><input type="radio" name="nota_selecionada" value="2"></td>
                        <td>789012</td>
                        <td>98.765.432/0001-10</td>
                        <td>Outra Empresa S.A.</td>
                        <td>R$ 2.500,00</td>
                        <td>98765432109876543210987654321098765432109876</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="test-section">
            <h3>üîß Bot√µes de A√ß√£o</h3>
            <button type="button" class="btn" id="btn-visualizar-danfe">
                üìÑ Visualizar nota
            </button>
            <button type="button" class="btn" id="btn-testar-extensao">
                üß™ Testar Extens√£o
            </button>
            <button type="button" class="btn" id="btn-limpar-status">
                üóëÔ∏è Limpar Status
            </button>
        </div>

        <div class="test-section">
            <h3>üìä Status da Extens√£o</h3>
            <div id="status-container">
                <div class="status info">
                    Aguardando a√ß√£o...
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>üìù Logs</h3>
            <div id="logs" style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                Logs aparecer√£o aqui...
            </div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para adicionar logs
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#6c757d';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        // Fun√ß√£o para atualizar status
        function updateStatus(message, type = 'info') {
            const container = document.getElementById('status-container');
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Verificar se a extens√£o est√° dispon√≠vel
        function checkExtension() {
            if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id) {
                chrome.runtime.sendMessage({ tipo: "Ping" }, (response) => {
                    if (chrome.runtime.lastError) {
                        addLog('Extens√£o n√£o dispon√≠vel: ' + chrome.runtime.lastError.message, 'error');
                        updateStatus('Extens√£o n√£o encontrada ou n√£o instalada', 'error');
                    } else {
                        addLog('Extens√£o dispon√≠vel e funcionando', 'success');
                        updateStatus('Extens√£o funcionando corretamente', 'success');
                    }
                });
            } else {
                addLog('Chrome runtime n√£o dispon√≠vel', 'error');
                updateStatus('Chrome runtime n√£o dispon√≠vel', 'error');
            }
        }

        // Interceptar bot√£o de visualizar nota (simulando o content script)
        function setupButtonInterception() {
            const btnVisualizar = document.getElementById('btn-visualizar-danfe');
            
            if (btnVisualizar) {
                addLog('Bot√£o de visualizar nota encontrado, interceptando...');
                
                btnVisualizar.addEventListener('click', async function(e) {
                    e.preventDefault();
                    addLog('Bot√£o visualizar nota clicado');
                    
                    const notaSelecionada = document.querySelector('input[name="nota_selecionada"]:checked');
                    if (!notaSelecionada) {
                        updateStatus('Por favor, selecione uma nota fiscal primeiro.', 'error');
                        addLog('Nenhuma nota selecionada', 'error');
                        return;
                    }
                    
                    const tr = notaSelecionada.closest('tr');
                    const nota = JSON.parse(tr.getAttribute('data-nota'));
                    const chave = (nota.chave || '').replace(/[^0-9]/g, '').trim();
                    
                    if (!chave || chave.length !== 44) {
                        updateStatus('Chave de acesso da nota inv√°lida ou n√£o encontrada.', 'error');
                        addLog('Chave inv√°lida: ' + chave, 'error');
                        return;
                    }
                    
                    addLog('Chave da nota: ' + chave);
                    updateStatus('Abrindo consulta via extens√£o...', 'info');
                    
                    // Tentar usar a extens√£o
                    if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id) {
                        try {
                            chrome.runtime.sendMessage({
                                tipo: "AbrirConsulta",
                                chave: chave
                            }, (response) => {
                                if (chrome.runtime.lastError) {
                                    addLog('Erro ao abrir consulta: ' + chrome.runtime.lastError.message, 'error');
                                    updateStatus('Erro ao abrir consulta via extens√£o', 'error');
                                } else {
                                    addLog('Consulta aberta com sucesso via extens√£o', 'success');
                                    updateStatus('Consulta aberta com sucesso!', 'success');
                                }
                            });
                        } catch (error) {
                            addLog('Erro inesperado: ' + error.message, 'error');
                            updateStatus('Erro inesperado ao usar extens√£o', 'error');
                        }
                    } else {
                        addLog('Extens√£o n√£o dispon√≠vel, simulando abertura...', 'info');
                        updateStatus('Extens√£o n√£o dispon√≠vel - simula√ß√£o', 'info');
                        setTimeout(() => {
                            updateStatus('Simula√ß√£o: Consulta seria aberta para chave ' + chave, 'success');
                        }, 1000);
                    }
                });
                
                addLog('Intercepta√ß√£o do bot√£o conclu√≠da');
            }
        }

        // Bot√£o de testar extens√£o
        document.getElementById('btn-testar-extensao').addEventListener('click', function() {
            addLog('Testando extens√£o...');
            checkExtension();
        });

        // Bot√£o de limpar status
        document.getElementById('btn-limpar-status').addEventListener('click', function() {
            document.getElementById('logs').innerHTML = 'Logs limpos...';
            updateStatus('Status limpo', 'info');
        });

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addLog('P√°gina de teste carregada');
            setupButtonInterception();
            checkExtension();
        });
    </script>
</body>
</html> 